---
/**
 * Seriph Form Component
 *
 * A wrapper component that handles form submission to Seriph.
 * You provide your own form fields via the default slot.
 *
 * @example
 * <Form siteKey={import.meta.env.SERIPH_SITE_KEY} formSlug="contact">
 *   <input name="name" placeholder="Name" required />
 *   <input name="email" type="email" placeholder="Email" required />
 *   <textarea name="message" placeholder="Message" required></textarea>
 *   <button type="submit">Send</button>
 * </Form>
 */

interface Props {
  /** Your site key (required) */
  siteKey: string;
  /** The form slug as configured in Seriph (required) */
  formSlug: string;
  /** Base URL of your Seriph instance (default: 'https://seriph.xyz') */
  endpoint?: string;
  /** Theme preset: 'light' (default), 'dark', or 'auto' (uses prefers-color-scheme) */
  theme?: "light" | "dark" | "auto";
  /** CSS class to add to the form */
  class?: string;
}

const DEFAULT_ENDPOINT = "https://seriph.xyz";
const API_PATH = "/api/v1";

const {
  siteKey,
  formSlug,
  endpoint = DEFAULT_ENDPOINT,
  theme = "light",
  class: className = "",
} = Astro.props;

// Build the API URL
const baseUrl = endpoint.replace(/\/+$/, "") + API_PATH;
---

<form
  class:list={["seriph-form", `seriph-theme-${theme}`, className]}
  data-seriph-form
  data-endpoint={baseUrl}
  data-site-key={siteKey}
  data-form-slug={formSlug}
>
  <slot />

  <!-- Honeypot field for spam protection (hidden from users, catches bots) -->
  <div style="position: absolute; left: -9999px;" aria-hidden="true">
    <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" />
  </div>

  <!-- Success/Error message container (hidden by default) -->
  <div class="seriph-form-message" style="display: none;" aria-live="polite"></div>
</form>

<script>
  interface FormSubmitResponse {
    success: boolean;
    message: string;
  }

  // Get or create a visitor ID for anonymous users
  const VISITOR_KEY = "seriph_visitor_id";
  function getVisitorId(): string {
    let id = localStorage.getItem(VISITOR_KEY);
    if (!id) {
      id = crypto.randomUUID();
      localStorage.setItem(VISITOR_KEY, id);
    }
    return id;
  }

  // Store form load timestamps for spam detection
  const formTimestamps = new WeakMap<Element, number>();

  document.querySelectorAll("[data-seriph-form]").forEach((form) => {
    // Record when form was loaded (for time-based spam detection)
    formTimestamps.set(form, Math.floor(Date.now() / 1000));

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formEl = e.target as HTMLFormElement;
      const endpoint = formEl.dataset.endpoint;
      const siteKey = formEl.dataset.siteKey;
      const formSlug = formEl.dataset.formSlug;
      const messageEl = formEl.querySelector(".seriph-form-message") as HTMLElement | null;
      const submitBtn = formEl.querySelector('[type="submit"]') as HTMLButtonElement | null;

      if (!endpoint || !siteKey || !formSlug) {
        const missing = [];
        if (!endpoint) missing.push("endpoint");
        if (!formSlug) missing.push("formSlug");
        if (!siteKey) {
          missing.push("siteKey (check SERIPH_SITE_KEY in your .env)");
        }
        console.error(`Seriph form missing required props: ${missing.join(", ")}`);
        return;
      }

      // Collect form data
      const formData = new FormData(formEl);
      const data: Record<string, unknown> = {};
      formData.forEach((value, key) => {
        data[key] = value;
      });

      // Add timestamp for time-based spam detection
      const loadTimestamp = formTimestamps.get(formEl);
      if (loadTimestamp) {
        data._seriph_ts = loadTimestamp;
      }

      // Dispatch loading event
      formEl.dispatchEvent(new CustomEvent("seriph:loading"));

      // Disable submit button
      if (submitBtn) {
        submitBtn.disabled = true;
      }

      try {
        const response = await fetch(`${endpoint}/forms/${formSlug}/submit`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Seriph-Key": siteKey,
            "X-Seriph-Visitor": getVisitorId(),
          },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || "Submission failed");
        }

        const result: FormSubmitResponse = await response.json();

        // Show success message
        if (messageEl) {
          messageEl.textContent = result.message;
          messageEl.style.display = "block";
          messageEl.className = "seriph-form-message seriph-form-success";
        }

        // Dispatch success event with response data
        formEl.dispatchEvent(
          new CustomEvent("seriph:success", {
            detail: result,
          }),
        );

        // Reset form on success
        formEl.reset();
      } catch (error) {
        // Show error message
        if (messageEl) {
          messageEl.textContent = error instanceof Error ? error.message : "Something went wrong";
          messageEl.style.display = "block";
          messageEl.className = "seriph-form-message seriph-form-error";
        }

        formEl.dispatchEvent(
          new CustomEvent("seriph:error", {
            detail: error,
          }),
        );
      } finally {
        // Re-enable submit button
        if (submitBtn) {
          submitBtn.disabled = false;
        }
      }
    });
  });
</script>

<style is:global>
  @layer seriph {
    .seriph-form {
      --seriph-success-bg: #dcfce7;
      --seriph-success-text: #166534;
      --seriph-success-border: #bbf7d0;
      --seriph-error-bg: #fef2f2;
      --seriph-error-text: #991b1b;
      --seriph-error-border: #fecaca;
    }

    /* Dark theme */
    .seriph-form.seriph-theme-dark {
      --seriph-success-bg: rgba(34, 197, 94, 0.15);
      --seriph-success-text: #86efac;
      --seriph-success-border: rgba(34, 197, 94, 0.3);
      --seriph-error-bg: rgba(239, 68, 68, 0.15);
      --seriph-error-text: #fca5a5;
      --seriph-error-border: rgba(239, 68, 68, 0.3);
    }

    /* Auto theme - follows prefers-color-scheme */
    @media (prefers-color-scheme: dark) {
      .seriph-form.seriph-theme-auto {
        --seriph-success-bg: rgba(34, 197, 94, 0.15);
        --seriph-success-text: #86efac;
        --seriph-success-border: rgba(34, 197, 94, 0.3);
        --seriph-error-bg: rgba(239, 68, 68, 0.15);
        --seriph-error-text: #fca5a5;
        --seriph-error-border: rgba(239, 68, 68, 0.3);
      }
    }

    .seriph-form-message {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
    }

    .seriph-form-success {
      background-color: var(--seriph-success-bg);
      color: var(--seriph-success-text);
      border: 1px solid var(--seriph-success-border);
    }

    .seriph-form-error {
      background-color: var(--seriph-error-bg);
      color: var(--seriph-error-text);
      border: 1px solid var(--seriph-error-border);
    }
  }
</style>
