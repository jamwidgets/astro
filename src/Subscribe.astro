---
/**
 * JamWidgets Subscribe Component
 *
 * A subscription form for email updates. Implements double opt-in -
 * users receive a confirmation email and must click to confirm.
 *
 * @example
 * <Subscribe siteKey={import.meta.env.JAMWIDGETS_SITE_KEY} />
 *
 * @example With custom styling
 * <Subscribe
 *   siteKey={import.meta.env.JAMWIDGETS_SITE_KEY}
 *   buttonText="Get Updates"
 *   placeholder="Enter your email"
 *   successMessage="Check your inbox!"
 * />
 */

interface Props {
  /** Your site key (required) */
  siteKey: string;
  /** Base URL of your JamWidgets instance (default: 'https://jamwidgets.com') */
  endpoint?: string;
  /** Submit button text (default: 'Subscribe') */
  buttonText?: string;
  /** Email input placeholder (default: 'your@email.com') */
  placeholder?: string;
  /** Success message override (default: uses server response) */
  successMessage?: string;
  /** Theme preset: 'light' (default), 'dark', or 'auto' (uses prefers-color-scheme) */
  theme?: "light" | "dark" | "auto";
  /** CSS class to add to the form */
  class?: string;
}

const DEFAULT_ENDPOINT = "https://jamwidgets.com";
const API_PATH = "/api/v1";

const {
  siteKey,
  endpoint = DEFAULT_ENDPOINT,
  buttonText = "Subscribe",
  placeholder = "your@email.com",
  successMessage,
  theme = "light",
  class: className = "",
} = Astro.props;

// Build the API URL
const baseUrl = endpoint.replace(/\/+$/, "") + API_PATH;
---

<form
  class:list={["jamwidgets-subscribe", `jamwidgets-theme-${theme}`, className]}
  data-jamwidgets-subscribe
  data-endpoint={baseUrl}
  data-site-key={siteKey}
  data-success-message={successMessage}
>
  <div class="jamwidgets-subscribe-input-group">
    <input
      type="email"
      name="email"
      required
      placeholder={placeholder}
      class="jamwidgets-subscribe-input"
      autocomplete="email"
    />
    <button type="submit" class="jamwidgets-subscribe-button">
      {buttonText}
    </button>
  </div>

  <!-- Honeypot field for spam protection (hidden from users, catches bots) -->
  <div style="position: absolute; left: -9999px;" aria-hidden="true">
    <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" />
  </div>

  <!-- Success/Error message container (hidden by default) -->
  <div class="jamwidgets-subscribe-message" style="display: none;" aria-live="polite"></div>
</form>

<script>
  interface SubscribeResponse {
    success: boolean;
    message: string;
  }

  // Get or create a visitor ID for anonymous users
  const VISITOR_KEY = "jamwidgets_visitor_id";
  function getVisitorId(): string {
    let id = localStorage.getItem(VISITOR_KEY);
    if (!id) {
      id = crypto.randomUUID();
      localStorage.setItem(VISITOR_KEY, id);
    }
    return id;
  }

  document.querySelectorAll("[data-jamwidgets-subscribe]").forEach((form) => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formEl = e.target as HTMLFormElement;
      const endpoint = formEl.dataset.endpoint;
      const siteKey = formEl.dataset.siteKey;
      const customSuccessMessage = formEl.dataset.successMessage;
      const messageEl = formEl.querySelector(".jamwidgets-subscribe-message") as HTMLElement | null;
      const submitBtn = formEl.querySelector('button[type="submit"]') as HTMLButtonElement | null;
      const inputEl = formEl.querySelector('input[name="email"]') as HTMLInputElement | null;

      if (!endpoint || !siteKey) {
        console.error("JamWidgets Subscribe: missing siteKey or endpoint");
        return;
      }

      // Collect form data
      const formData = new FormData(formEl);
      const data: Record<string, unknown> = {};
      formData.forEach((value, key) => {
        data[key] = value;
      });

      // Dispatch loading event
      formEl.dispatchEvent(new CustomEvent("jamwidgets:loading"));

      // Disable submit button and show loading state
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.dataset.originalText = submitBtn.textContent || "";
        submitBtn.textContent = "...";
      }

      try {
        const response = await fetch(`${endpoint}/subscribe`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-JamWidgets-Key": siteKey,
            "X-JamWidgets-Visitor": getVisitorId(),
          },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || "Subscription failed");
        }

        const result: SubscribeResponse = await response.json();

        // Show success message
        if (messageEl) {
          messageEl.textContent = customSuccessMessage || result.message;
          messageEl.style.display = "block";
          messageEl.className = "jamwidgets-subscribe-message jamwidgets-subscribe-success";
        }

        // Dispatch success event with response data
        formEl.dispatchEvent(
          new CustomEvent("jamwidgets:success", {
            detail: result,
          }),
        );

        // Clear input on success
        if (inputEl) {
          inputEl.value = "";
        }
      } catch (error) {
        // Show error message
        if (messageEl) {
          messageEl.textContent = error instanceof Error ? error.message : "Something went wrong";
          messageEl.style.display = "block";
          messageEl.className = "jamwidgets-subscribe-message jamwidgets-subscribe-error";
        }

        formEl.dispatchEvent(
          new CustomEvent("jamwidgets:error", {
            detail: error,
          }),
        );
      } finally {
        // Re-enable submit button
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = submitBtn.dataset.originalText || "Subscribe";
        }
      }
    });
  });
</script>

<style is:global>
  .jamwidgets-subscribe {
    --jamwidgets-border-color: #d1d5db;
    --jamwidgets-input-bg: #ffffff;
    --jamwidgets-input-text: #111827;
    --jamwidgets-button-bg: #4f46e5;
    --jamwidgets-button-text: #ffffff;
    --jamwidgets-button-hover: #4338ca;
    --jamwidgets-success-bg: #dcfce7;
    --jamwidgets-success-text: #166534;
    --jamwidgets-success-border: #bbf7d0;
    --jamwidgets-error-bg: #fef2f2;
    --jamwidgets-error-text: #991b1b;
    --jamwidgets-error-border: #fecaca;
    --jamwidgets-focus-ring: rgba(79, 70, 229, 0.5);
    position: relative;
  }

  /* Dark theme */
  .jamwidgets-subscribe.jamwidgets-theme-dark {
    --jamwidgets-border-color: #4b5563;
    --jamwidgets-input-bg: #1f2937;
    --jamwidgets-input-text: #f9fafb;
    --jamwidgets-button-bg: #6366f1;
    --jamwidgets-button-hover: #818cf8;
    --jamwidgets-success-bg: rgba(34, 197, 94, 0.15);
    --jamwidgets-success-text: #86efac;
    --jamwidgets-success-border: rgba(34, 197, 94, 0.3);
    --jamwidgets-error-bg: rgba(239, 68, 68, 0.15);
    --jamwidgets-error-text: #fca5a5;
    --jamwidgets-error-border: rgba(239, 68, 68, 0.3);
  }

  /* Auto theme - follows prefers-color-scheme */
  @media (prefers-color-scheme: dark) {
    .jamwidgets-subscribe.jamwidgets-theme-auto {
      --jamwidgets-border-color: #4b5563;
      --jamwidgets-input-bg: #1f2937;
      --jamwidgets-input-text: #f9fafb;
      --jamwidgets-button-bg: #6366f1;
      --jamwidgets-button-hover: #818cf8;
      --jamwidgets-success-bg: rgba(34, 197, 94, 0.15);
      --jamwidgets-success-text: #86efac;
      --jamwidgets-success-border: rgba(34, 197, 94, 0.3);
      --jamwidgets-error-bg: rgba(239, 68, 68, 0.15);
      --jamwidgets-error-text: #fca5a5;
      --jamwidgets-error-border: rgba(239, 68, 68, 0.3);
    }
  }

  .jamwidgets-subscribe-input-group {
    display: flex;
    gap: 0.5rem;
  }

  .jamwidgets-subscribe-input {
    flex: 1;
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--jamwidgets-border-color);
    border-radius: 0.375rem;
    background-color: var(--jamwidgets-input-bg);
    color: var(--jamwidgets-input-text);
    font-size: 0.875rem;
    line-height: 1.25rem;
  }

  .jamwidgets-subscribe-input:focus {
    outline: none;
    border-color: var(--jamwidgets-button-bg);
    box-shadow: 0 0 0 3px var(--jamwidgets-focus-ring);
  }

  .jamwidgets-subscribe-input::placeholder {
    color: #9ca3af;
  }

  .jamwidgets-subscribe-button {
    padding: 0.625rem 1rem;
    border: none;
    border-radius: 0.375rem;
    background-color: var(--jamwidgets-button-bg);
    color: var(--jamwidgets-button-text);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.15s ease;
    white-space: nowrap;
  }

  .jamwidgets-subscribe-button:hover:not(:disabled) {
    background-color: var(--jamwidgets-button-hover);
  }

  .jamwidgets-subscribe-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .jamwidgets-subscribe-message {
    margin-top: 0.75rem;
    padding: 0.625rem 0.875rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
  }

  .jamwidgets-subscribe-success {
    background-color: var(--jamwidgets-success-bg);
    color: var(--jamwidgets-success-text);
    border: 1px solid var(--jamwidgets-success-border);
  }

  .jamwidgets-subscribe-error {
    background-color: var(--jamwidgets-error-bg);
    color: var(--jamwidgets-error-text);
    border: 1px solid var(--jamwidgets-error-border);
  }
</style>
